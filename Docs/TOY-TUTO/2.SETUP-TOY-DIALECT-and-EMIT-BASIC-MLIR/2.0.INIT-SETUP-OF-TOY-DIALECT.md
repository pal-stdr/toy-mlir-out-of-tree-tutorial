# Initializing the Setup of TOY `Dialect`

- For what & why of `MLIR` - [Docs/MLIR-KNOWLEDGE-BASE/1.WHAT-WHY-OF-MLIR.md](../../MLIR-KNOWLEDGE-BASE/1.WHAT-WHY-OF-MLIR.md)
- A short intro to `MLIR` Dialect - [Docs/MLIR-KNOWLEDGE-BASE/2.WHAT-IS-DIALECT.md](../../MLIR-KNOWLEDGE-BASE/2.WHAT-IS-DIALECT.md)


- **I WILL STRONGLY RECOMMEND TO READ [Chapter 2: Emitting Basic MLIR](https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/) FROM BEGINNING UNTIL THE END OF THE [Using the Operation Definition Specification (ODS) Framework](https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/#using-the-operation-definition-specification-ods-framework) SECTION THOROUGHLY. THEN START FOLLOWING THE REST OF THIS DOC.**


# Why do we need to define `Dialect`?

Until now, we have done upto the `AST` generation for our Toy language. <ins>**To interface that toy `AST` with `MLIR`, we have to define a new Toy `Dialect`.** This dialect will model the structure of the Toy language, as well as provide an easy avenue for high-level analysis and transformation.

# Objectives

- **Define a `ToyDialectBase` from where we will start to extend the `ToyOps` in the next chapter.**
- **Section 1 discusses, how to play with the code assets for Dialects at `tools/toy-compiler/include/` dir; including `CMake` configs**
- **Section 2 discusses, how to play with the code assets for Dialects at `tools/toy-compiler/lib/` dir; including `CMake` configs**
- **Section 3 discusses, how to update the main CMake config (i.e. `tools/toy-compiler/CMakeLists.txt`) for the things done in Section 1 & Section 2.**
- **Section 4 discusses, how the Dialect files (i.e. `.td`) are managed by MLIR infrastructure.**
- **Section 5 shows, the updated scaffold of `tools/toy-compiler` dir.**
- **(Optional) Section 6 includes the scaffold of `build/tools/toy-compiler/include` dir to show where can be the autogenerated headers (i.e. `ToyDialectBase.h.inc` & `ToyDialectBase.cpp.inc`) are found.**


# Resources

Codes are collected from `llvm-18-src-build/mlir/examples/toy/Ch2`


# 1. Manage Header + Dialect files at `tools/toy-compiler/include/` dir

## 1.1. Create `Dialect/ToyDialect/` dirs at `tools/toy-compiler/include/`

This is where the `ToyDialectBase.h` and `ToyDialectBase.td` will be created and populated. 

```sh
mkdir -p tools/toy-compiler/include/Dialect/ToyDialect
```

## 1.2. Create `ToyDialectBase.td` at `tools/toy-compiler/include/Dialect/ToyDialect/`

```sh
touch tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td
```

## 1.3. Now let's put the following content inside `tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td`

```js
/// Provide a definition of the 'ToyDialect' dialect in the ODS framework so that we
/// can register our operations to it.
def Toy_Dialect : Dialect {
    let name = "toy";
    let summary = "A high-level dialect for analyzing and optimizing the Toy language";

    // A much longer description of our dialect.
    let description = [{
        The Toy language is a tensor-based language that allows you to define functions, perform some math computation, and print results. This dialect provides a representation of the language that is amenable to analysis and optimization.
    }];

    let cppNamespace = "::mlir::toy";
}
```


### 1.3.1. What is `ToyDialectBase.td` & Why?

`ToyDialectBase.td` is a file where you will define your `Dialect` in `declarative` manner. From the name (i.e. `ToyDialectBase`) you can guess, this holds the base `Dialect` declaration + definition for `Toy` lang. Later all the `Ops` will be extended from this file.

In short, `ToyDialectBase.td` is a `TableGen` file which will hold the base class for `ToyDialect` in [`ODS` format](https://mlir.llvm.org/docs/DefiningDialects/Operations/). And using this `ODS` format in `TableGen` file, Dialects can be declared in a `Declarative Way`. **Why?** We will learn that in section `1.3.4.2` & `1.3.4.3`.



### 1.3.2. So... What is `Dialect`?

- **Dialects are the `containers` of `rules` & `specifications` for modeling the structure of a language AST to `IR`. Not just only that, a Dialect can transform other Dialect too üòÆ.**

- Dialect can be also written for `IR` to `IR`. This is called IR translation or IR lowering. IR translation is the process of converting IR from one dialect to another.

- MLIR is designed to allow all IR elements, such as `attributes`, `operations`, and `types`, to be customized for a Dialect.


### 1.3.3 Typical `specifications` of a Dialect
- `name` of the Dialect.
- `Description` of the Dialect.
- `type` of input arguments.
- `type` of output/`return`.
- Defining `Ops` (For this, we will be using `ODS` framework)
- etc.


### 1.3.4. So why this weird `syntax` for a `Dialect`? Language or Frameworks used for defining a Dialect

**<ins>1.3.4.1. Language or Frameworks for Dialect</ins>:**
- <ins>Dialects can be defined using **C++**. But MLIR also supports defining dialects declaratively via [LLVM TableGen](https://llvm.org/docs/TableGen/ProgRef.html).</ins>
- **Those `.td` files will be automatically converted to `C++` headers (i.e. `.h` files) + Definitions (i.e. `.cpp` files) while building `toy-compiler` binary.**

**<ins>1.3.4.2. Why declarative dialect rather than using `C++`?</ins>**
- **Using the declarative specification is much cleaner as it removes the need for a large portion of the boilerplate when defining a new dialect.**
- **It also enables easy generation of dialect documentation, which can be described directly alongside the dialect.**


- **Why `ODS`? ü§î**

Let's read what the official doc says

> Facts regarding an operation are specified concisely into a TableGen record, which will be expanded into an equivalent `mlir::Op` C++ template specialization at compile time. **Using the ODS framework is the desired way for defining operations in MLIR given the simplicity, conciseness, and general stability in the face of C++ API changes**.

So the last sentence is very important ü§î. Especially the part, where it says - **"general stability in the face of C++ API changes"**.


**<ins>1.3.4.3. So the `ODS` & `TableGen` formats are different? It's pretty confusing!! No? ü§î</ins>:**

`ODS` and `TableGen` both are tools used to define MLIR dialects. However, they have different strengths and weaknesses.

`ODS` is a more modern and flexible approach to defining MLIR dialects. It is based on a type system that is more expressive than the `type` system used by `TableGen`. This allows `ODS` to define more complex and powerful dialects. `ODS` is also more modular than `TableGen`, which means that it is easier to break down complex dialects into smaller, more manageable pieces.

`TableGen` is a legacy tool that is still widely used to define MLIR dialects. **It is a simpler and more streamlined approach than `ODS`. This makes it easier to learn and use, and it is also more efficient for defining simple dialects. However, `TableGen` is not as expressive or flexible as `ODS`, and it is more difficult to break down complex dialects into smaller pieces.**

**So which one to use?**
- `ODS` is a better choice for defining complex MLIR dialects that need to be highly expressive and modular. **`ODS` will be used to write Toy Dialect.**
- `TableGen` is a better choice for defining simple MLIR dialects that need to be easy to learn and use.


## 1.4. Now create `ToyDialectBase.h` at `tools/toy-compiler/include/Dialect/ToyDialect/`

`ToyDialectBase.h` will be used to `#include` the **autogenerated** class declaration of the `ToyDialect`. This autogeneration process is defined in `tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt`. How to do trigger? We will learn that in section `1.6.2.`.

```sh
touch tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.h
```

## 1.5. Now let's put the following content inside `tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.h`

Read the comments and you will understand üòâ.

```C++
#ifndef TOY_DIALECT_H_
#define TOY_DIALECT_H_

/// Call dependency header "mlir/IR/Dialect.h" for having autogenerated "ToyDialectBase.h.inc"
/// In, "ToyDialectBase.h.inc", "ToyDialect" class is automatically created from "public ::mlir::Dialect" class.
/// So you need it
#include "mlir/IR/Dialect.h"


/// Include the auto-generated header file containing the declaration of the toy dialect.
/// You will find it in "build/tools/include/Dialect/ToyDialect/" dir
#include "Dialect/ToyDialect/ToyDialectBase.h.inc"


#endif // TOY_DIALECT_H_
```


## 1.6. Now it's time to do the `CMake` config to autogenerate the `ToyDialectBase.h.inc` & `ToyDialectBase.cpp.inc`. Start configuring `CMake` considering `tools/toy-compiler/include/` dir

**Now we need to make the CMake mechanism to trigger the **autogeneration** of `C++` class declaration + definitions as `ToyDialectBase.h.inc` & `ToyDialectBase.cpp.inc`.**


[Note: I will Highly recommend to read the section **2.1. add_subdirectory():** from [Docs/MISCELLANEOUS/CMAKE-HOW-TO/CMAKE-KNOWLEDGE.md](../../MISCELLANEOUS/CMAKE-HOW-TO/CMAKE-KNOWLEDGE.md). The thing I am going to do here, explained in very very vast details there.]


### 1.6.1. Create `project-root/cmake/MyCustomCmakeUtils.cmake` with following content & define some utility `cmake` functions for autogenerating dialect doc

- This doc generation **is not mandatory** for your actual `Toy` build system. But nice to have.

```sh
mkdir -p cmake
touch cmake/MyCustomCmakeUtils.cmake
```

- Then add this at the end of your `project-root/CMakeLists.txt` like following. read the comments for better understanding.

```cmake
......
.......
.....
add_subdirectory(standalone-plugin)
add_subdirectory(standalone-translate)

# ==== Added later ====

# ==== Customize CMake ====
# ---- Custom CMake Utility Functions -----
include("${CMAKE_CURRENT_SOURCE_DIR}/cmake/MyCustomCmakeUtils.cmake")

add_subdirectory(tools)
```

- Now dump the `add_mlir_doc_customized` cmake function definition in that file. Read all the code comments to understand what is happening here.


```cmake
# Collected from - https://github.com/llvm/llvm-project/blob/e302950023cd99251371c5dc8a1e3b609dd5a8fe/mlir/cmake/modules/AddMLIR.cmake#L162C1-L176C14
# Generate ".md" Documentation
# Arguments:
# doc_filename: The name of your dialect file. i.e. "${dialect_name}DialectBase.td"
# output_file_name: The name of the output doc file. Whatever you want, you can set it.
# output_directory: Where you want to have it. Default prefix path is "build/docs/your-set-dir/". i.e. set it to "your-set-dir/".
# command: i.e. "-gen-op-doc"
# Example: add_mlir_doc_customized("ToyOps" "ToyOps" "ToyDialect/" "-gen-op-doc")
# Output:
# "${output_file_name}.md" in "build/docs/${output_directory}" dir
# How to activate the doc gen?
# In "build-mlir-18.sh" file, set "cmake --build . --target mlir-doc"
function(add_mlir_doc_customized doc_filename output_file_name output_directory command)

    set(LLVM_TARGET_DEFINITIONS ${doc_filename}.td)

    # The MLIR docs use Hugo, so we allow Hugo specific features here.
    tablegen(MLIR ${output_file_name}.md ${command} -allow-hugo-specific-features ${ARGN})

    set(GEN_DOC_FILE ${STANDALONE_BINARY_DIR}/docs/${output_directory}${output_file_name}.md)

    # build/docs/output_directory/
    # message(STATUS "${GEN_DOC_FILE}")

    add_custom_command(
            OUTPUT ${GEN_DOC_FILE}
            COMMAND ${CMAKE_COMMAND} -E copy
                    ${CMAKE_CURRENT_BINARY_DIR}/${output_file_name}.md
                    ${GEN_DOC_FILE}
            DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/${output_file_name}.md)
    add_custom_target(${output_file_name}DocGen DEPENDS ${GEN_DOC_FILE})
    add_dependencies(mlir-doc ${output_file_name}DocGen)

endfunction()
```


### 1.6.2 Create `CMakeLists.txt` at `tools/toy-compiler/include/Dialect/ToyDialect/` dir.

```sh
touch tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt
```



### 1.6.3. Now add following to `tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt`

- Autogeneration of `.inc` headers will be triggered from `toy-compiler/lib/Dialect/ToyDialect/CMakeLists.txt` using `${INC_GEN_TARGET_NAME}`. How to trigger this, I will show you in chapter **2.4.2 Now populate `tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt` with following cmake `command()`**.

```cmake
# Added in Ch 2.0.
# Set dialect name (i.e. "Toy") and namespace (i.e. "toy")
# Following variables will be first used in "lib/Dialect/ToyDialect/CMakeLists.txt".
# Then from there, they will passed to "include/Dialect/ToyDialect/CMakeLists.txt"
set(DIALECT_NAME "Toy")

# Coming from "let cppNamespace = "::mlir::toy";" defined in "include/Dialect/ToyDialect/ToyDialectBase.td" 
set(DIALECT_NAMESPACE "toy")
set(TOY_CHAPTER "Ch20")


# ======== Autogenerating .inc headers (Starts) ========

# Mandatory
set(LLVM_TARGET_DEFINITIONS "${DIALECT_NAME}DialectBase.td")

# generated header name for ${DIALECT_NAME} == "Toy", ToyDialectBase.h.inc and ToyDialectBase.cpp.inc
mlir_tablegen("${DIALECT_NAME}DialectBase.h.inc" -gen-dialect-decls -dialect="${DIALECT_NAMESPACE}")
mlir_tablegen("${DIALECT_NAME}DialectBase.cpp.inc" -gen-dialect-defs -dialect="${DIALECT_NAMESPACE}")

# i.e. Inc target name is "ToyCh20IncGen".
# "lib/Dialect/ToyDialect/CMakeLists.txt" will call "ToyCh20IncGen" as a dependency to generate the .inc headers before running the compilation.
set(INC_GEN_TARGET_NAME "${DIALECT_NAME}${TOY_CHAPTER}IncGen")
add_public_tablegen_target("${INC_GEN_TARGET_NAME}")


# ======== Autogenerating .inc headers (Ends) ========



# (Optional)
# Generate Dialect's ".md" Documentation
# Arguments:
# doc_filename: The name of your dialect file. i.e. "${dialect_name}DialectBase.td"
# output_file_name: The name of the output doc file. Whatever you want, you can set it.
# output_directory: Where you want to have it. Default prefix path is "build/docs/your-set-dir/". i.e. set it to "your-set-dir/".
# command: i.e. "-gen-op-doc"
# Example: add_mlir_doc_customized("ToyOps" "ToyOps" "ToyDialect/" "-gen-op-doc")
# Output:
# "${output_file_name}.md" in "build/docs/${output_directory}" dir
# How to activate the doc gen?
# In "build-mlir-18.sh" file, set "cmake --build . --target mlir-doc"
add_mlir_doc_customized("ToyDialectBase" "ToyDialectBase" "ToyDialect/" "-gen-dialect-doc")
```





### 1.6.4. Things to do later:

- Auto generated headers will be dumped at `build/tools/toy-compiler/include/Dialect/ToyDialect/`. (Typical generated file names are `ToyDialectBase.cpp.inc`, `ToyDialectBase.cpp.inc.d`, `ToyDialectBase.h.inc`, `ToyDialectBase.h.inc.d`)

- The main CMake config file for our toy compiler (i.e. `tools/toy-compiler/CMakeLists.txt`) has to know this that the header include path as the argument for it's `-I` flag.

- So we have to add `include_directories("build/tools/toy-compiler/include/")` at `tools/toy-compiler/CMakeLists.txt` later. Check the `tools/toy-compiler/CMakeLists.txt` at section `3.3` to have an idea on how they are added.

- (Optional) Here you can ask, the autogenerated headers are dumped at `build/tools/toy-compiler/include/Dialect/ToyDialect/`. So I should include this one. Then why am I also including `build/tools/toy-compiler/include/`? Nice question üòâ. This is because, if later I add more Dialects, I donot have to specify their paths using `include_directories()` again and again. And to maintain that, in all Dialect `.h` + `.cpp` files (i.e. `ToyDialectBase.h`, `ToyDialectBase.cpp`), we have to call `#include` as relative path like `#include Dialect/ToyDialect/ToyDialectBase.h.inc`, `#include Dialect/ToyDialect/ToyDialectBase.h`, or `#include Dialect/ToyDialect/ToyDialectBase.cpp.inc`. So now if you concatenate, it would be like this **`build/tools/toy-compiler/include/` + `Dialect/ToyDialect/ToyDialectBase.h` = `build/tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.h` üòÅ**



### 1.6.5. Create `CMakeLists.txt` at `tools/toy-compiler/include/Dialect` dir.

Because, step by step we have to create the cmake config connection to the outward dir nest, so that the settings in `tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt` can be recognized/detected by, first `tools/toy-compiler/include/Dialect/CMakeLists.txt`, then `tools/toy-compiler/include/CMakeLists.txt`, and finally by `tools/toy-compiler/CMakeLists.txt`.

- Create `CMakeLists.txt` at `tools/toy-compiler/include/Dialect/`

```sh
touch tools/toy-compiler/include/Dialect/CMakeLists.txt
```

- Now add inside `tools/toy-compiler/include/Dialect/CMakeLists.txt`

```cmake
add_subdirectory(ToyDialect)
```

### 1.6.6. Create `CMakeLists.txt` at `tools/toy-compiler/include/` dir.

Because, step by step we have to create the cmake config connection to the outward dir nest, so that finally `tools/toy-compiler/CMakeLists.txt` detect it.

- Create `CMakeLists.txt`

```sh
touch tools/toy-compiler/include/CMakeLists.txt
```

- Now add inside `tools/toy-compiler/include/CMakeLists.txt`

```cmake
add_subdirectory(Dialect)
```

**Done for `tools/toy-compiler/include/` part üòá**





# 2. Manage Header + Dialect files at `tools/toy-compiler/lib/` dir


## 2.1. Create dirs `Dialect/ToyDialect` at `tools/toy-compiler/lib/`

```sh
mkdir -p tools/toy-compiler/lib/Dialect/ToyDialect/
```

## 2.2. Create `ToyDialectBase.cpp` at `tools/toy-compiler/lib/Dialect/ToyDialect`

```sh
touch tools/toy-compiler/lib/Dialect/ToyDialect/ToyDialectBase.cpp
```

## 2.3. Populate `tools/toy-compiler/lib/Dialect/ToyDialect/ToyDialectBase.cpp` with `ToyDialect` init code

```C++
/// 'ToyDialect' member in namespace 'mlir::toy' is coming from this header.
/// Actually, in "ToyDialectBase.h.inc", the "ToyDialect" class is created from "public ::mlir::Dialect" class.
/// And "ToyDialectBase.h" is calling "ToyDialectBase.h.inc" header
#include "Dialect/ToyDialect/ToyDialectBase.h"

// To-do: Later, here you have to include the header "ToyOps.h"
// Because we need "ToyOps.cpp.inc" to register to the "ToyDialect::initialize()"


using namespace mlir;
using namespace mlir::toy;



/// This ".cpp.inc" file is autogenerated by CMake function (in include/Dialect/ToyDialect/CMakeLists.txt)
/// using the flag "-gen-dialect-defs". Without this file, we cannot initialize the Dialect.
/// ToyDialectBase instance will be owned by the mlir::MLIRContext.
#include "Dialect/ToyDialect/ToyDialectBase.cpp.inc"




//===----------------------------------------------------------------------===//
// To-do: Call Ops header for registering Toy Ops (and types)
//===----------------------------------------------------------------------===//

/// To-do:
/// Call the Ops init configuration header which contains "ToyOps.h.inc" header call
/// Different Ops member declaration will be coming from this header.
/// This header should also contain the standard MLIR Interface lib calls like "BytecodeOpInterface.h", "CallInterfaces.h", etc.
/// After successful inclusion, you'd be able to register the Ops inside "ToyDialect::initialize()"



//===----------------------------------------------------------------------===//
// ToyDialect Initialize
//===----------------------------------------------------------------------===//

/// Dialect initialization. This is the point of registration of types
/// and operations for the dialect.
/// Now it is doing nothing, just sitting ducks.
void ToyDialect::initialize() {
    
    // "addOperations<>()" coming from "mlir/IR/Dialect.h"
    // "addOperations" is not '+' operations :). It's telling to add all operations
    addOperations<
        // To-do: Add autogenerated ToyOps declaration (i.e. ToyOps.cpp.inc)
    >();
}
```


## 2.4. Start configuring `CMake` considering `tools/toy-compiler/lib/Dialect/ToyDialect/` dir

### 2.4.1 Create `CMakeLists.txt` at `tools/toy-compiler/lib/Dialect/ToyDialect/` dir.

```sh
touch tools/toy-compiler/lib/Dialect/ToyDialect/CMakeLists.txt
```

### 2.4.2. Now populate `tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt` with following cmake `command()`

```cmake
# "MLIRToyDialectCPP" is the alias through which tools/toy-compiler/CMakeLists.txt will target this lib
add_mlir_dialect_library(MLIRToyDialectBaseCPP
    ToyDialectBase.cpp

    DEPENDS
    ToyCh20IncGen # <= Telling cmake to trigger the generation of .inc headers first.
)
```

### 2.4.3 Create `CMakeLists.txt` at `tools/toy-compiler/lib/Dialect/` dir.

Because, step by step we have to create the cmake config connection to the outward dir nest, so that the settings in `tools/toy-compiler/lib/Dialect/ToyDialect/CMakeLists.txt` can be recognized/detected by, first `tools/toy-compiler/lib/Dialect/CMakeLists.txt`, then `tools/toy-compiler/lib/CMakeLists.txt`, and finally by `tools/toy-compiler/CMakeLists.txt`.

- Create `CMakeLists.txt` at `tools/toy-compiler/lib/Dialect/`

```sh
touch tools/toy-compiler/lib/Dialect/CMakeLists.txt
```

- Now add inside `tools/toy-compiler/lib/Dialect/CMakeLists.txt`

```cmake
add_subdirectory(ToyDialect)
```


### 2.4.4. Now update the `tools/toy-compiler/lib/CMakeLists.txt`

```cmake
add_subdirectory(toy-parser)

# Added in Ch 2.0.
add_subdirectory(Dialect)
```

**Done for `tools/toy-compiler/lib/Dialect` part üòá**



# 3. Now update the `tools/toy-compiler/CMakeLists.txt`

## 3.1. CMake config To-dos for the configs done in `/tools/toy-compiler/include`

- To point to the auto generated headers `ToyDialectBase.h.inc` & `ToyDialectBase.cpp.inc`, have to add `include_directories("${STANDALONE_BINARY_DIR}/tools/toy-compiler/include")`. Here `${STANDALONE_BINARY_DIR} == build/`
- To trigger autogeneration commands in `tools/toy-compiler/include/Dialect/ToyDialect/CMakeLists.txt`, add `add_subdirectory("${TOY_INCLUDE_DIR}")` 

## 3.2. CMake config To-dos for the configs done in `/tools/toy-compiler/lib/Dialect/ToyDialect`
- `/tools/toy-compiler/lib/Dialect/ToyDialect/ToyDialectBase.cpp` is aliased as `MLIRToyDialectBaseCPP`. Add it to `SET(LIBS MLIRToyDialectBaseCPP)`

## 3.3. Final updated `tools/toy-compiler/CMakeLists.txt` will look like...

```cmake
# Set Toy Compiler binary filename
set(TOY_COMPILER_BIN_NAME "toy-compiler")


# "${CMAKE_CURRENT_SOURCE_DIR}" always reads where the current `CMakeLists.txt` is located
# Right now ${CMAKE_CURRENT_SOURCE_DIR} is called from this "/path/to/toy-mlir-out-of-tree-tutorial/tools/toy-compiler/CMakeLists.txt" file
# So, ${CMAKE_CURRENT_SOURCE_DIR} == ${TOY_MAIN_SRC_DIR} == /path/to/mlir-project/tools/toy-compiler


# Set all the required dirs
set(TOY_MAIN_SRC_DIR "${CMAKE_CURRENT_SOURCE_DIR}")
set(TOY_INCLUDE_DIR "${TOY_MAIN_SRC_DIR}/include")
set(TOY_LIB_DIR "${TOY_MAIN_SRC_DIR}/lib")


# Point header files location (i.e. /path/to/mlir-project/tools/toy-compiler/include)
include_directories("${TOY_INCLUDE_DIR}")


# Added in Ch 2.0.
# ${STANDALONE_BINARY_DIR} == /path/to/mlir-project/build/
# Example case: For the auto gen ".inc" type headers like "ToyDialectBase.h.inc" at "tools/toy-compiler/include/Dialect/ToyDialect", the common location is - build/tools/toy-compiler/include/
include_directories("${STANDALONE_BINARY_DIR}/tools/toy-compiler/include")


# Added in Ch 2.0.
# We have to also add the "${TOY_INCLUDE_DIR}" as "add_subdirectory()"
# So now cmake will also treat this dir as subdirectory to run the commands()
# Read section "2.1. `add_subdirectory()`" from "Docs/MISCELLANEOUS/CMAKE-HOW-TO/CMAKE-KNOWLEDGE.md" to understand the details
add_subdirectory("${TOY_INCLUDE_DIR}")



# Point lib files location (i.e. /path/to/mlir-project/tools/toy-compiler/lib)
# Why use "add_subdirectory", go to "Docs/MISCELLANEOUS/CMAKE-HOW-TO/CMAKE-KNOWLEDGE.md" and read "2.1. add_subdirectory()"
add_subdirectory("${TOY_LIB_DIR}")


# add new lib `MLIRToyParser` (i.e. alias to `AST.cpp`)
set(LIBS
        MLIRToyParser
        MLIRToyDialectBaseCPP # <= Added in Ch 2.0
)


add_llvm_executable("${TOY_COMPILER_BIN_NAME}" toy-compiler.cpp)

# src- https://stackoverflow.com/a/71388662
# llvm_update_compile_flags adds -fno-exceptions to property COMPILE_FLAGS not COMPILE_DEFINITIONS
# Second, llvm_update_compile_flags inserts a space in front of the flag
llvm_update_compile_flags("${TOY_COMPILER_BIN_NAME}")

target_link_libraries("${TOY_COMPILER_BIN_NAME}" PRIVATE ${LIBS})

mlir_check_all_link_libraries("${TOY_COMPILER_BIN_NAME}")

install(TARGETS "${TOY_COMPILER_BIN_NAME}" DESTINATION bin)
```

**Done for updating `tools/toy-compiler/CMakeLists.txt` part üòá**





# 4. How MLIR infrastructure handles the Dialect (i.e. `.td`) files?

- As already discussed in section `1.3.3` & `1.3.4`, we know `Dialects` (& `Ops`) are defined using [ODS Format](https://mlir.llvm.org/docs/DefiningDialects/Operations/) inside `TableGen` files (`.td` files). So `.td` files are the dialect files. And this is how `Ops` (i.e. `Operations`) are described for a dialect.

- `.td` files are the src files from which we generate Dialect + Ops declarations (e.g. `ToyDialectBase.h.inc`) and definitions (e.g. `ToyDialectBase.cpp.inc`).

- Those header's are auto generated every time we build `toy-compiler`. They are `C++` version of Dialect, that we have defined in `Dialect/ToyDialect/ToyDialectBase.td` TableGen using `ODS` format. This concept is exceptionally handy, because the `clang++` compiler we currently using to build the `toy-compiler`, cannot compile `ToyDialectBase.td`. That's why, every time we launch the build command through `build-mlir-18.sh`, those header's are autogenerated **on-the-fly** by CMake `mlir_tablegen()` command.

- Autogeneration could be triggered by other build system like `Bazel`. Just there we need to have a similar kind of function as like as `mlir_tablegen()`.

- `mlir-tblgen` command is used with different flags to generate Operation declarations, definitions, docs etc. Actually CMake `mlir_tablegen()` is a wrapper around `mlir-tblgen`. You can find it in your llvm src build bins dir (e.g. for our use case `$LLVM_PROJECT_ROOT/installation/bin/mlir-tblgen` or `$LLVM_PROJECT_ROOT/build/bin/mlir-tblgen`).

- to generate Dialect declarations, use `-gen-dialect-decls` flag and for definitions, use `gen-dialect-defs` flag.

- to generate operations declarations, use `-gen-op-decls` flag and for definitions, use `gen-op-defs` flag.

- To generate Dialect docs, use flag `-gen-dialect-doc`

- To generate Operation docs, use flag `-gen-op-doc`



## 4.1. Generate `Dialect` Declaration with flag `-gen-dialect-decls`

- Let's assume your `echo $LLVM_PROJECT_ROOT` is `/path/to/llvm-18-src-build`

```sh
$LLVM_PROJECT_ROOT/installation/bin/mlir-tblgen -gen-dialect-decls tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td -I $LLVM_PROJECT_ROOT/mlir/include/

# Or,
$LLVM_PROJECT_ROOT/build/bin/mlir-tblgen -gen-dialect-decls tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td -I $LLVM_PROJECT_ROOT/mlir/include/

# Returns
/*===- TableGen'erated file -------------------------------------*- C++ -*-===*\
|*                                                                            *|
|* Dialect Declarations                                                       *|
|*                                                                            *|
|* Automatically generated file, do not edit!                                 *|
|* From: ToyDialectBase.td                                                    *|
|*                                                                            *|
\*===----------------------------------------------------------------------===*/

namespace mlir {
namespace toy {

class ToyDialect : public ::mlir::Dialect {
  explicit ToyDialect(::mlir::MLIRContext *context);

  void initialize();
  friend class ::mlir::MLIRContext;
public:
  ~ToyDialect() override;
  static constexpr ::llvm::StringLiteral getDialectNamespace() {
    return ::llvm::StringLiteral("toy");
  }
};
} // namespace toy
} // namespace mlir
MLIR_DECLARE_EXPLICIT_TYPE_ID(::mlir::toy::ToyDialect)
```

## 4.2. Generate `Dialect` Definitions with flag `-gen-dialect-defs`

- Let's assume your `echo $LLVM_PROJECT_ROOT` is `/path/to/llvm-18-src-build`

```sh
$LLVM_PROJECT_ROOT/installation/bin/mlir-tblgen -gen-dialect-defs tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td -I $LLVM_PROJECT_ROOT/mlir/include/

# Or,
$LLVM_PROJECT_ROOT/build/bin/mlir-tblgen -gen-dialect-defs tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td -I $LLVM_PROJECT_ROOT/mlir/include/

# Returns
/*===- TableGen'erated file -------------------------------------*- C++ -*-===*\
|*                                                                            *|
|* Dialect Definitions                                                        *|
|*                                                                            *|
|* Automatically generated file, do not edit!                                 *|
|* From: ToyDialectBase.td                                                    *|
|*                                                                            *|
\*===----------------------------------------------------------------------===*/

MLIR_DEFINE_EXPLICIT_TYPE_ID(::mlir::toy::ToyDialect)
namespace mlir {
namespace toy {

ToyDialect::ToyDialect(::mlir::MLIRContext *context)
    : ::mlir::Dialect(getDialectNamespace(), context, ::mlir::TypeID::get<ToyDialect>()) {
  
  initialize();
}

ToyDialect::~ToyDialect() = default;

} // namespace toy
} // namespace mlir
```

## 4.3. Generate `Dialect` Docs with flag `-gen-dialect-doc`

```sh
$LLVM_PROJECT_ROOT/installation/bin/mlir-tblgen -gen-dialect-doc tools/toy-compiler/include/Dialect/ToyDialect/ToyDialectBase.td -I $LLVM_PROJECT_ROOT/mlir/include/

# Returns
<!-- Autogenerated by mlir-tblgen; don't manually edit -->
# 'toy' Dialect

A high-level dialect for analyzing and optimizing the Toy language
The Toy language is a tensor-based language that allows you to define functions, perform some math computation, and print results. This dialect provides a representation of the language that is amenable to analysis and optimization.

[TOC]
```


# 5. The following scaffold view will help you to understand very quickly.

- For details, please read section **2.1.2. How/Where should I use `add_subdirectory()`** from [Docs/MISCELLANEOUS/CMAKE-HOW-TO/CMAKE-KNOWLEDGE.md](Docs/MISCELLANEOUS/CMAKE-HOW-TO/CMAKE-KNOWLEDGE.md)

```sh
‚îú‚îÄ‚îÄ cmake
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ MyCustomCmakeUtils.cmake # <== add_mlir_dialect_customized() defined here w/ tablegen commands to generate .inc type headers.
....
...
‚îî‚îÄ‚îÄ tools
    ‚îú‚îÄ‚îÄ CMakeLists.txt
    ‚îî‚îÄ‚îÄ toy-compiler
        ‚îú‚îÄ‚îÄ CMakeLists.txt
        ‚îú‚îÄ‚îÄ include
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CMakeLists.txt # <== Newly added
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Dialect # <== Newly added
        ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CMakeLists.txt
        ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ToyDialect
        ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ CMakeLists.txt # <== Autogeneration process of ".inc" type headers are defined here.
        ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ ToyDialectBase.h
        ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ ToyDialectBase.td
        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ toy-analysis-parser
        ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ AST.h
        ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ Lexer.h
        ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ Parser.h
        ‚îú‚îÄ‚îÄ lib
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CMakeLists.txt
        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Dialect # <== Newly added
        ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CMakeLists.txt
        ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ToyDialect
        ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ CMakeLists.txt # <== ToyDialectBase.cpp is calling the alias "ToyCh2OpsIncGen" as it's dependency to execute all tablegen commands first; before Dialect.cpp is called by final compilation chain.
        ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ ToyDialectBase.cpp # <== Initialize the ToyDialect
        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ toy-parser
        ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ AST.cpp
        ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ CMakeLists.txt
        ‚îî‚îÄ‚îÄ toy-compiler.cpp
```



## 6. Want to have a birds-eye-view where those `ToyDialectBase.h.inc` & `ToyDialectBase.cpp.inc` files generate? (Only Visualization purpose)

```sh
‚îú‚îÄ‚îÄ cmake
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ MyCustomCmakeUtils.cmake # <== add_mlir_doc_customized() defined here with tablegen commands to generate dialect docs.
.........
......
‚îú‚îÄ‚îÄ build
    ‚îú‚îÄ‚îÄ bin
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ toy-compiler
    ‚îú‚îÄ‚îÄ docs # <== Where the docs are generated
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Standalone
    ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ StandaloneDialect.md
    ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ StandaloneOps.md
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ToyDialect
    ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ ToyDialectBase.md
....
.......
    ‚îî‚îÄ‚îÄ tools
        ‚îú‚îÄ‚îÄ CMakeFiles
        ‚îú‚îÄ‚îÄ cmake_install.cmake
        ‚îî‚îÄ‚îÄ toy-compiler
            ‚îú‚îÄ‚îÄ CMakeFiles
            ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ toy-compiler.dir
            ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ toy-compiler.cpp.o
            ‚îú‚îÄ‚îÄ cmake_install.cmake
            ‚îú‚îÄ‚îÄ include
            ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CMakeFiles
            ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ cmake_install.cmake
            ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ Dialect
            ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ CMakeFiles
            ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ cmake_install.cmake
            ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ ToyDialect # <== This is where you can find your autogenerated header files (doc files too..)
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ CMakeFiles
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ cmake_install.cmake
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ ToyDialectBase.cpp.inc
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ ToyDialectBase.cpp.inc.d
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ ToyDialectBase.h.inc
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ ToyDialectBase.h.inc.d
            ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ ToyDialectBase.md
            ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ ToyDialectBase.md.d
            ‚îî‚îÄ‚îÄ lib
                ‚îú‚îÄ‚îÄ CMakeFiles
                ‚îú‚îÄ‚îÄ cmake_install.cmake
                ‚îú‚îÄ‚îÄ Dialect
                ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CMakeFiles
                ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ cmake_install.cmake
                ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ToyDialect
                ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ CMakeFiles
                ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ MLIRToyDialectBaseCPP.dir
                ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ obj.MLIRToyDialectBaseCPP.dir
                ‚îÇ¬†¬†     ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ ToyDialectBase.cpp.o
                ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ cmake_install.cmake
                ‚îî‚îÄ‚îÄ toy-parser
                    ‚îú‚îÄ‚îÄ CMakeFiles
                    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ MLIRToyParser.dir
                    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ obj.MLIRToyParser.dir
                    ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ AST.cpp.o
                    ‚îî‚îÄ‚îÄ cmake_install.cmake
....
.......
‚îú‚îÄ‚îÄ tools
    ‚îú‚îÄ‚îÄ CMakeLists.txt
    ‚îî‚îÄ‚îÄ toy-compiler
....
.......
```